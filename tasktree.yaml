# yaml-language-server: $schema=schema/tasktree-schema.json
runners:
  default: bash-strict
  bash-strict:
    shell: /usr/bin/bash
    preamble: set -euo pipefail

tasks:
  dev-setup:
    desc: Install development dependencies
    cmd: uv sync --extra dev

  check:
    desc: Run all checks (tests and build)
    deps: [test, build, check-lint, check-format]
    cmd: echo "✓ All checks passed!"

  test:
    desc: Run the test suite
    inputs: [src/**/*.py, tests/**/*.py]
    cmd: |
      set -e
      
      # These are invoked separately so that they fail faster
      PYTHONPATH=tests uv run pytest tests/unit
      PYTHONPATH=tests uv run pytest tests/integration
      PYTHONPATH=tests uv run pytest tests/e2e

  coverage:
    desc: Run tests with coverage check
    inputs: [src/**/*.py, tests/**/*.py]
    cmd: PYTHONPATH=tests uv run pytest --cov=src/tasktree --cov-report=term-missing

  check-format:
    inputs: [src/**/*.py, tests/**/*.py]
    cmd: uv format --check
  
  check-lint:
    inputs: [src/**/*.py, tests/**/*.py]
    cmd: ruff check src tests

  fix:
    deps: [fix-format, fix-lint]
    cmd: echo "✓ All fixes complete!"

  fix-format:
    inputs: [src/**/*.py, tests/**/*.py]
    cmd: uv format

  fix-lint:
    inputs: [src/**/*.py, tests/**/*.py]
    cmd: ruff check --fix src tests

  build:
    desc: Build distribution packages (wheel and sdist)
    deps: [test]
    inputs: [src/**/*.py, pyproject.toml, README.md]
    outputs: [dist/*.whl, dist/*.tar.gz]
    cmd: uv build

  clean:
    desc: Remove build artifacts and cache files
    cmd: |
      rm -rf dist/ build/ *.egg-info .venv
      rm -rf .pytest_cache
      find . -type d -name __pycache__ -exec rm -rf {} + 2>/dev/null || true